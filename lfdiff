#!/usr/bin/perl

use warnings;
use strict;
use Getopt::Std;

#-------- constants --------
my $splitsize = (2*1024*1024*1024);
#------- /constants --------

sub printerr
{
  print STDERR "@_";
}

sub usage {
  printerr <<EOL;
usage:
lfdiff [-h] [-v] [-f] [-o OUTPUT] INPUT1 INPUT2
\t-f: force overwriting
\t-o: write output to OUTFILE instead of stdout
\t-v: be verbose
\t-h: print usage
EOL
}

sub errorexit {
  printerr @_;
  usage;
  exit 1;
}

my %args;
#$Getopt::Std::STANDARD_HELP_VERSION = 1;
if (getopts( 'ho:vf', \%args )) {
#  errorexit "error parsing commandline\n";
}

if (defined $args{h} and $args{h} ne '') {
    usage();
    exit 0;
}

my $filename = $args{o};
if (defined $filename) {
  # redirect STDOUT to file
  open (STDOUT, ">", $filename) or die "Unable to open file '$filename': $!";
}

my $useforce = $args{f};
my $beverbose = $args{v};

if ($#ARGV+1 < 2) {
    errorexit "error: missing input files\n";
}

my $fileA = $ARGV[0];
my $fileB = $ARGV[1];

if ($fileA eq $fileB) {
    errorexit "error: input files are same\n";
}

# split files
printerr "splitting $fileA\n";
system("split --line-bytes=$splitsize $fileA ${fileA}.x >&2");
printerr "splitting $fileB\n";
system("split --line-bytes=$splitsize $fileB ${fileB}.x >&2");

# diff the splitted files
# and remove the splits after saving the diffs
for my $A ('a'..'z') {
    for my $B ('a'..'z') {
        printerr "$A$B";
        my $splitA = "${fileA}.x$A$B";
        my $splitB = "${fileB}.x$A$B";
        my $diff = "${fileB}.x$A$B.diff";
        if ( -f $splitA and -f $splitB ) {
            if ( -f $diff ) {
                errorexit "error: $diff exists. Use -f to force writing\n";
            }
            system("diff --speed-large-files $splitA $splitB > $diff");
            unlink ($splitA);
            unlink ($splitB);           
        }
        elsif (-f $splitA ) {
            system("diff --speed-large-files $splitA /dev/null > $diff");
            unlink ($splitA);
        }
        elsif (-f $splitB ) {
            system("diff --speed-large-files /dev/null $splitB > $diff");
            unlink ($splitB);           
        }
        else {
            last;
        }
        
        # correct the line numbers and push diff to output
#        open(DIFF, "<", $diff) || die "$0: could not open $diff: $!";
#        while (<DIFF>) {
#            print $_;
#        }
#        close(DIFF);
    }
}


